<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Regalos de Boda</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  body {
    margin:0;
    background:#fafafa;
    font-family:"Segoe UI", sans-serif;
  }
  .center {
    text-align:center;
    padding:30px;
  }
  .welcome-img {
    width:100%;
    max-width:420px;
    border-radius:20px;
    box-shadow:0 4px 12px rgba(0,0,0,0.2);
  }
  .login-box { margin-top:20px; }
  .hidden { display:none; }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
    gap: 25px;
    padding: 20px;
  }

  .card {
    background:white;
    border-radius:14px;
    overflow:hidden;
    cursor:pointer;
    border:3px solid transparent;
    transition:.25s ease;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
  }

  .card img {
    width:100%;
    height:200px;
    object-fit:cover;
  }

  .card-content { padding:16px; }

  .agotado {
    opacity:0.4;
    pointer-events:none;
    filter: grayscale(100%);
  }

  #confirm-btn {
    display:block;
    margin:25px auto;
    padding:12px 30px;
    background:#0077ff;
    color:white;
    border:none;
    border-radius:12px;
    font-size:18px;
    cursor:pointer;
  }

  #confirm-btn:disabled {
    background:#aaa;
    cursor:not-allowed;
  }
</style>
</head>

<body>

<!-- PANTALLA DE BIENVENIDA -->
<div id="welcome" class="center">
  <img id="foto-boda" class="welcome-img" 
       src="https://raw.githubusercontent.com/Ch3lo94/Regalos_Boda/main/images/IMG-20251127-WA0008.jpg">

  <h2>Nos ayudar√≠as mucho con estas cosas que nos faltan ‚ù§Ô∏è</h2>
  <p>Ingres√° con tu cuenta de Google y eleg√≠ el regalo.</p>

  <div id="g_id_onload"
    data-client_id="342769047778-jc52eh3n59a3vjocagmomi8pln5kbqv3.apps.googleusercontent.com"
    data-callback="handleCredentialResponse">
  </div>

  <div class="login-box g_id_signin"
    data-type="standard"
    data-size="large"
    data-theme="filled_blue">
  </div>
</div>

<!-- CAT√ÅLOGO -->
<div id="catalogo" class="hidden">
  <h1 class="center">Eleg√≠ un regalo</h1>
  <div id="grid" class="grid"></div>
  <button id="confirm-btn" disabled>Confirmar selecci√≥n</button>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwOz_hUq0xRZmTel05NglgrK0rLX4W_U987q7eQ-aTV4s6Bt_87erQ4ccSaJTlmzPnv/exec";

let usuario = null;
let seleccion = [];

/* LOGIN GOOGLE */
async function handleCredentialResponse(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));

  usuario = { 
    nombre: payload.given_name,
    apellido: payload.family_name,
    email: payload.email.toLowerCase()
  };

  // CONSULTA AL BACKEND SI YA RESPONDI√ì
  const check = await fetch(API + "?email=" + usuario.email);
  const data = await check.json();

  if (data.yaRespondio) {
    document.body.innerHTML = `
      <h1 style="text-align:center;margin-top:40px;">
        Ya registramos tu respuesta ‚ù§Ô∏è
      </h1>
      <p style="text-align:center;">¬°Gracias por ayudarnos!</p>
    `;
    return;
  }

  // SI NO RESPONDI√ì ‚Üí MOSTRAR CAT√ÅLOGO
  document.getElementById("welcome").classList.add("hidden");
  document.getElementById("catalogo").classList.remove("hidden");

  cargarCatalogo();
}

/* CATALOGO */
async function cargarCatalogo() {
  const res = await fetch(API);
  const items = await res.json();

  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  items.forEach(item => {
    const card = document.createElement("div");
    card.className = "card";

    if (item.stockRestante <= 0) card.classList.add("agotado");

    card.innerHTML = `
      <img src="${item.imagen}">
      <div class="card-content">
        <h3>${item.nombre}</h3>
        <p>${item.descripcion || ''}</p>
      </div>
    `;

    card.onclick = () => toggle(item.id, card);
    grid.appendChild(card);
  });
}

function toggle(id, card) {
  if (seleccion.includes(id)) {
    seleccion = seleccion.filter(x => x !== id);
    card.style.border = "3px solid transparent";
  } else {
    seleccion.push(id);
    card.style.border = "3px solid #0077ff";
  }

  document.getElementById("confirm-btn").disabled = seleccion.length === 0;
}

/* CONFIRMAR REGALO */
document.getElementById("confirm-btn").onclick = async () => {
  const resp = await fetch(API, {
    method: "POST",
    body: JSON.stringify({
      nombre: usuario.nombre,
      apellido: usuario.apellido,
      email: usuario.email,
      seleccion
    })
  });

  const r = await resp.json();

  if (!r.success) {
    alert(r.error);
    return;
  }

  // MENSAJE FINAL Y BLOQUEO
  document.body.innerHTML = `
    <h1 style="text-align:center;margin-top:40px;">
      ¬°Gracias por tu regalo! üéÅ‚ù§Ô∏è
    </h1>
    <p style="text-align:center;">Tu respuesta qued√≥ registrada.</p>
  `;
};
</script>

</body>
</html>
